<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Iterations]]></title>
  <subtitle><![CDATA[Figuring it out... One step at a time.]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="http://ericmbarnard.com/"/>
  <updated>2015-04-29T03:49:32.589Z</updated>
  <id>http://ericmbarnard.com/</id>
  
  <author>
    <name><![CDATA[Eric M Barnard]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[Unit Testing Web API: Authorized Requests]]></title>
    <link href="http://ericmbarnard.com/2015/04/unit-testing-webapi-authorized-requests.html"/>
    <id>http://ericmbarnard.com/2015/04/unit-testing-webapi-authorized-requests.html</id>
    <published>2015-04-29T16:35:41.000Z</published>
    <updated>2015-04-29T03:49:32.589Z</updated>
    <content type="html"><![CDATA[<h2 id="Why?">Why?</h2><p>Since Web API has been out, I’ve been a huge fan - and one of those main reasons has been testability. In most of the applications I’ve ever built, I’ve specifically chosen to put the majority of heavy lifting under Web API’s responsibility rather than ASP.NET MVC’s (and yes, most of my deployments are MVC apps with Web API running inside). However, I wanted to share my approach to actually testing my Web API controllers and how my philosophy works because, as you’ll see, there’s often a lot more that needs to be tested than simply the controller.</p>
<h2 id="Oh,_The_Examples…">Oh, The Examples…</h2><p>It seems like most of the examples out there of trying to Unit Test Web API Controllers (or most of ASP.NET ones, for that matter) seem to gloss over the fact that a lot of us need to test things that require authorization to take place at some point in the request pipeline. There’s also a significant amount of us developing applications that are taking advantage of <a href="http://www.hanselman.com/blog/ListOfNETDependencyInjectionContainersIOC.aspx" target="_blank" rel="external">IoC Containers</a> and <a href="https://lostechies.com/jimmybogard/2013/10/10/put-your-controllers-on-a-diet-redux/" target="_blank" rel="external">separating our business logic</a> away from the controller (I’m not religious about this, but I have found it to be helpful for myself). So, hopefully the following example can be something that helps a few folks out. </p>
<h2 id="The_Philosophy">The Philosophy</h2><p>Ok, so first off I rarely (if ever) solely test controllers by themselves. As you’ll see I keep the majority of my business logic outside of the controller and thus the controller really becomes the point in my application where values from an HTTP request are transitioned into parameters for my business logic. Hopefully, if you think about what is happening at the point a controller’s action is being invoked, what I’m saying makes sense as a critical point in the framework-to-application logic junction. At such a critical point in our request’s lifetime, I want to have tests around that ensure that if I ever change a route or my AJAX requests are failing - I know where I can replicate and fix things with tests.</p>
<p>So, for the most part my Web API controller and tests look something like the following (we’ll break it down further). I do use <a href="https://lostechies.com/jimmybogard/2014/09/09/tackling-cross-cutting-concerns-with-a-mediator-pipeline/" target="_blank" rel="external">Mediatr</a> and <a href="http://structuremap.github.io/" target="_blank" rel="external">StructureMap</a> - but I would argue that you could accomplish what I’m doing in this post without them.<br><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> Mediatr;</span><br><span class="line"></span><br><span class="line">[Authorize]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SomeController</span> : <span class="title">ApiController</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IMediator _mediator;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SomeController</span><span class="params">(IMediator mediator)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        _mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IHttpActionResult&gt; <span class="title">Get</span><span class="params">(SomeListRequest req)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> _mediator.SendAsync(req);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Ok(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>and the test<br><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Web.Http;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.VisualStudio.TestTools.UnitTesting;</span><br><span class="line"></span><br><span class="line">[TestClass]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SomeControllerTests</span> : <span class="title">ApiControllerTestBase</span></span><br><span class="line">&#123;</span><br><span class="line">    [TestMethod]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">SomeController_IndexWorks</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// arrange</span></span><br><span class="line">        <span class="keyword">var</span> vm      = <span class="keyword">new</span> SomeListViewModel();</span><br><span class="line">        <span class="keyword">var</span> ctrller = CreateController();</span><br><span class="line">        <span class="keyword">this</span>.Mediator.SendAsyncOverride = (x =&gt; vm);</span><br><span class="line">        <span class="keyword">this</span>.Container.Inject(ctrller);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// act</span></span><br><span class="line">        <span class="keyword">var</span> resp = <span class="keyword">await</span> Client.GetAsync(<span class="string">"/api/some/"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// assert</span></span><br><span class="line">        Assert.IsTrue(resp.IsSuccessStatusCode);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> resp.Content.ReadAsAsync&lt;SomeListViewModel&gt;();</span><br><span class="line">        Assert.AreEqual(<span class="number">0</span>, vm.Items.Count);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// helper method in case the dependencies get a bit gnarly</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SomeController <span class="title">CreateController</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SomeController(<span class="keyword">this</span>.Mediator);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The idea here is, hopefully, fairly straightforward. The <code>Mediator</code> does the hardwork of handing request parameters off to business-logic classes and then marshalls the business-logic result back to send as part of the HTTP response. It is the object that allows us to pull our business logic out of the controllers and into individual classes that <em>can</em> be more readily test-able. Here we simply use a fake <code>Mediator</code> and set it up to respond with our empty viewmodel. We then tell our IoC Container to use our already contstructed instance of our controller when it needs to resolve one and voila - we can now test an end-to-end HTTP request/response scenario against our Web API application and be sure it goes through our mocked-up controller.</p>
<h2 id="The_Test_Base_Class">The Test Base Class</h2><p>As you might be able to tell, the test above is relying quite a bit on its base class <code>ApiControllerTestBase</code>. What’s going on there?</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> System.Web.Http;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Owin;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Owin.Testing;</span><br><span class="line"><span class="keyword">using</span> Microsoft.VisualStudio.TestTools.UnitTesting;</span><br><span class="line"></span><br><span class="line">[TestClass]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">ApiControllerTestBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> HttpConfiguration HttpConfig &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> TestServer Server &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> HttpClient Client &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> FakeMediator Mediator &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    [TestInitialize]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// An override-able fake of a Mediatr.Mediator</span></span><br><span class="line">        Mediator = <span class="keyword">new</span> FakeMediator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> config = <span class="keyword">new</span> HttpConfiguration();</span><br><span class="line">        <span class="comment">// make sure that Web API sets up the same routes and configuration</span></span><br><span class="line">        <span class="comment">// as the app will in production</span></span><br><span class="line">        WebApiConfig.Register(config);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// more to come on this one</span></span><br><span class="line">        config.MessageHandlers.Add(<span class="keyword">new</span> UnitTestMessageHandler());</span><br><span class="line">        config.IncludeErrorDetailPolicy = IncludeErrorDetailPolicy.Always;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In-memory Web API Server for unit testing</span></span><br><span class="line">        Server = TestServer.Create(app =&gt; </span><br><span class="line">            &#123;</span><br><span class="line">                app.UseWebApi(config);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        Client = Server.HttpClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Cleanup</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.Client.Dispose();</span><br><span class="line">        <span class="keyword">this</span>.Server.Dispose();</span><br><span class="line">        <span class="keyword">this</span>.HttpConfig.Dispose();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Effectively, there’s nothing much more here than setting up and tearing down an in-memory instance of a Web API server each time a test is ran. We go through some steps to ensure the test server’s configuration is the same as our actual application, and we inject a special message handler (more below). The <code>TestServer</code> class is actually a product of Microsoft’s effort to make unit testing Web API even easier. You can get it with this NuGet Package: <a href="https://www.nuget.org/packages/Microsoft.Owin.Testing/" target="_blank" rel="external">Microsoft.Owin.Testing</a><br><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Install-Package Microsoft.Owin.Testing</span><br></pre></td></tr></table></figure></p>
<p>The <code>UnitTestMessageHandler</code> is a special <code>MessageHandler</code> I’ve created to help setup my requests within unit tests to give me a hand when I need one. I usually start out by just making sure the <code>IsLocal</code> value is in the request in case I have any logic that uses that within my app (i.e. don’t call production API’s, etc…): </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UnitTestMessageHandler</span> : <span class="title">DelegatingHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Task&lt;HttpResponseMessage&gt; <span class="title">SendAsync</span><span class="params">(</span><br><span class="line">                            HttpRequestMessage request, </span><br><span class="line">                            CancellationToken cancellationToken)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// make all of our requests appear "local"</span></span><br><span class="line">        request.Properties[<span class="string">"MS_IsLocal"</span>] = <span class="keyword">new</span> Lazy&lt;<span class="keyword">bool</span>&gt;(() =&gt; <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.SendAsync(request, cancellationToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With this in place, I can add any other values into my requests to mimic production issues/requests as need be.</p>
<h2 id="Requests_that_require_Authorization">Requests that require Authorization</h2><p>So finally, the point of this entire post. What do we do when we have controllers or actions that require authorization (or not just even authorization, but also specific roles)? Well we need a way to mock a user for our requests and then tell the pipeline to think that user is authorized. This ultimately comes down to using the <code>IPrincipal</code> and <code>IIdentity</code> -based classes. Nowadays this will most likely involve setting up a fake <code>ClaimsIdentity</code> and <code>ClaimsPrincipal</code>. I do that by sticking those values on my test base class, where I can tweak them as need be for each test. The following will setup a real ClaimsPrincipal similar to what is created by <a href="http://www.asp.net/identity/overview/getting-started/aspnet-identity-recommended-resources" target="_blank" rel="external">ASP.NET Identity</a><br><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[TestClass]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">ApiControllerTestBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ClaimsPrincipal User &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    [TestInitialize]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span></span><br><span class="line">    </span>&#123; </span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">this</span>.User = SetupClaimsPrincipal();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> ClaimsPrincipal <span class="title">SetupClaimsPrincipal</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> claims = <span class="keyword">new</span> List&lt;Claim&gt;();</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// UserId</span></span><br><span class="line">        claims.Add(<span class="keyword">new</span> Claim(</span><br><span class="line">            issuer:<span class="string">@"LOCAL AUTHORITY"</span>,</span><br><span class="line">            type:<span class="string">@"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"</span>,</span><br><span class="line">            <span class="keyword">value</span>:<span class="string">@"e427434e-b922-4138-ba0b-6fd88188da12"</span>,</span><br><span class="line">            valueType: <span class="string">@"http://www.w3.org/2001/XMLSchema#string"</span></span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// UserName</span></span><br><span class="line">        claims.Add(<span class="keyword">new</span> Claim(</span><br><span class="line">            issuer: <span class="string">@"LOCAL AUTHORITY"</span>,</span><br><span class="line">            type: <span class="string">@"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"</span>,</span><br><span class="line">            <span class="keyword">value</span>: <span class="string">@"john.doe@test.com"</span>,</span><br><span class="line">            valueType: <span class="string">@"http://www.w3.org/2001/XMLSchema#string"</span></span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Provider</span></span><br><span class="line">        claims.Add(<span class="keyword">new</span> Claim(</span><br><span class="line">            issuer: <span class="string">@"LOCAL AUTHORITY"</span>,</span><br><span class="line">            type: <span class="string">@"http://schemas.microsoft.com/accesscontrolservice/2010/07/claims/identityprovider"</span>,</span><br><span class="line">            <span class="keyword">value</span>: <span class="string">@"ASP.NET Identity"</span>,</span><br><span class="line">            valueType: <span class="string">@"http://www.w3.org/2001/XMLSchema#string"</span></span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// SecurityStamp</span></span><br><span class="line">        claims.Add(<span class="keyword">new</span> Claim(</span><br><span class="line">            issuer: <span class="string">@"LOCAL AUTHORITY"</span>,</span><br><span class="line">            type: <span class="string">@"AspNet.Identity.SecurityStamp"</span>,</span><br><span class="line">            <span class="keyword">value</span>: <span class="string">@"a0605331-ac20-42de-9e2c-8bc32bf3299b"</span>,</span><br><span class="line">            valueType: <span class="string">@"http://www.w3.org/2001/XMLSchema#string"</span></span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Role</span></span><br><span class="line">        claims.Add(<span class="keyword">new</span> Claim(</span><br><span class="line">            issuer: <span class="string">@"LOCAL AUTHORITY"</span>,</span><br><span class="line">            type: <span class="string">@"http://schemas.microsoft.com/ws/2008/06/identity/claims/role"</span>,</span><br><span class="line">            <span class="keyword">value</span>: <span class="string">@"Administrator"</span>,</span><br><span class="line">            valueType: <span class="string">@"http://www.w3.org/2001/XMLSchema#string"</span></span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> roleType = <span class="string">@"http://schemas.microsoft.com/ws/2008/06/identity/claims/role"</span>;</span><br><span class="line">        <span class="keyword">var</span> nameType = <span class="string">@"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"</span>;</span><br><span class="line">        <span class="keyword">var</span> identity = <span class="keyword">new</span> ClaimsIdentity(claims, <span class="string">"ApplicationCookie"</span>, nameType, roleType);</span><br><span class="line">        <span class="keyword">var</span> principal = <span class="keyword">new</span> ClaimsPrincipal(identity);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> principal;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>And then I will use this configured user within my setup logic for my base class as so:<br><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[TestClass]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">ApiControllerTestBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ClaimsPrincipal User &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    [TestInitialize]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span></span><br><span class="line">    </span>&#123; </span><br><span class="line">        <span class="comment">// ... other setup</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">this</span>.User = SetupClaimsPrincipal();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... Web API config setup</span></span><br><span class="line">        </span><br><span class="line">        config.MessageHandlers.Add(<span class="keyword">new</span> UnitTestMessageHandler(<span class="keyword">this</span>.User));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... other setup</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UnitTestMessageHandler</span> : <span class="title">DelegatingHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UnitTestMessageHandler</span><span class="params">(ClaimsPrincipal user)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.User = user;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ClaimsPrincipal User &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Task&lt;HttpResponseMessage&gt; <span class="title">SendAsync</span><span class="params">(</span><br><span class="line">                            HttpRequestMessage request, </span><br><span class="line">                            CancellationToken cancellationToken)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// setup the Request's principal</span></span><br><span class="line">        <span class="keyword">var</span> ctx = request.GetRequestContext();</span><br><span class="line">        ctx.Principal = <span class="keyword">this</span>.User;</span><br><span class="line">        request.SetRequestContext(ctx);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// make all of our requests appear "local"</span></span><br><span class="line">        request.Properties[<span class="string">"MS_IsLocal"</span>] = <span class="keyword">new</span> Lazy&lt;<span class="keyword">bool</span>&gt;(() =&gt; <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.SendAsync(request, cancellationToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>And that’s it. Once you’ve got that plumbing in place, you can test all kinds of different authorization scenarios with your Web API application and have fairly fine-grained control over what’s being faked and what’s not. I’ve personally gotten a lot of mileage on this style of setup in my test suites - and I hope that you find it valuable as well. If you have any further ideas - please sound off in the comments.</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="Why?">Why?</h2><p>Since Web API has been out, I’ve been a huge fan - and one of those main reasons has been testability. In most of ]]>
    </summary>
    
      <category term="aspnet" scheme="http://ericmbarnard.com/tags/aspnet/"/>
    
      <category term="csharp" scheme="http://ericmbarnard.com/tags/csharp/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Using Hexo for Static Websites]]></title>
    <link href="http://ericmbarnard.com/2015/04/using-hexo-for-static-websites.html"/>
    <id>http://ericmbarnard.com/2015/04/using-hexo-for-static-websites.html</id>
    <published>2015-04-27T12:56:35.000Z</published>
    <updated>2015-04-27T14:39:18.801Z</updated>
    <content type="html"><![CDATA[<h2 id="The_Problem">The Problem</h2><p>I’ve been doing some work to setup some basic websites (and moving my blog off of blogger). I really wanted to take advantage of a <a href="https://www.staticgen.com/" target="_blank" rel="external">static site generator</a>, and I wanted to utilize some of the best cheap hosting I could find (i.e. free). I know that I can point a custom domain to a <a href="https://pages.github.com/" target="_blank" rel="external">GitHub Pages</a> repository for nothing. GitHub Pages supports Jekyll as a static site generator - but I really didn’t want to have to go down the road of setting up Jekyll on my Windows machine (it runs on Ruby and I’ve had very little luck with all the Ruby Windows installation tools out there). I’m not against Ruby, and I have a Mac partition on my machine - but it’s not my primary working environment. <strong>What I really want is a site generator that runs on both platforms, like on NodeJS.</strong></p>
<h2 id="Enter_Hexo">Enter <a href="https://www.hexo.io" target="_blank" rel="external">Hexo</a></h2><p>I’ll spare the intro to <a href="https://www.hexo.io" target="_blank" rel="external">Hexo</a> - but suffice it to say it’s one of the more (if not most) popular NodeJS-based site generators out there. It’s actively contributed to (from folks all over the world) - and I found it quite easy to grok once I got started. The <a href="https://hexo.io/docs/" target="_blank" rel="external">Docs</a> are pretty good, and I was able to pretty much completely move my blog and build a custom theme over the course of a couple evenings.</p>
<h2 id="Why_Hexo?">Why Hexo?</h2><p>There were a number of things that helped me land on Hexo. For the most part it came down to: </p>
<ul>
<li>GitHub-Flavored Markdown support</li>
<li>Official support for LESS</li>
<li><a href="https://hexo.io/docs/permalinks.html" target="_blank" rel="external">Permalink</a>-extensibility (so I could prevent broken links when migrating sites)</li>
<li>Easily customizable themes</li>
<li><a href="http://ejs.co/" target="_blank" rel="external">EJS</a> support (more on that below)</li>
<li>Supported deployment story with Git and GitHub</li>
</ul>
<p>I mentioned EJS templating support. I realize that there are tons of other new and shiny templating languages out there - but one thing I really like about EJS is the fact that, as a developer, I can drop down and write raw JavaScript (the language EJS is written in) to get things done. A lot of other templating languages might be written in a different language but supported in Hexo (or other static site generators) by having a wrapper layer over them… which generally means there’s not a good story for working with the bare language if need be. </p>
<p>Overall, I’m pretty happy with Hexo and I hope I get some more chances to use it. I still primarily work in .NET and JavaScript - so I’m not making some big jump to web-design-only work, but this was a fun little project. You can check out the <a href="https://github.com/ericmbarnard/ericmbarnard.github.io-hexo" target="_blank" rel="external">source</a> of this blog and see what I did.</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="The_Problem">The Problem</h2><p>I’ve been doing some work to setup some basic websites (and moving my blog off of blogger). I really]]>
    </summary>
    
      <category term="JavaScript" scheme="http://ericmbarnard.com/tags/javascript/"/>
    
      <category term="NodeJS" scheme="http://ericmbarnard.com/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Leaving, Learning and Teaching]]></title>
    <link href="http://ericmbarnard.com/2015/04/leaving-learning-teaching.html"/>
    <id>http://ericmbarnard.com/2015/04/leaving-learning-teaching.html</id>
    <published>2015-04-10T12:00:00.000Z</published>
    <updated>2015-04-26T13:26:56.737Z</updated>
    <content type="html"><![CDATA[<p>Today is my last day at Codagami. It’s been almost exactly 3 years since I started, and I can’t say enough about how much I’ve learned and grown over those three years. I’m moving on for a multitude of reasons - some bigger than others and some smaller - nothing bad. Most importantly, though, I’m moving on to continue growing and challenging myself in new directions.</p>
<h2 id="The_Details">The Details</h2><p>First, I’m leaving because eventually I’ll be starting a new position with our local community college, <a href="http://www.parkland.edu/" target="_blank" rel="external">Parkland College</a> as an instructor in their Computer Science and Information Technology department. I’m taking this position because I’ve always loved the teaching experiences I’ve had with any role I’ve been in and I’ve wanted to get closer to that area with my career moves than further. I’ll start by teaching a summer course or two and then begin full-time teaching in the fall.</p>
<p>As part of the new role I’ll be taking with Parkland, I am being given the opportunity to help coordinate some major updates to their software development curriculum and programs. I realize this will be a lot of work, but at the end of the day I am pretty stoked about the idea that I’ll be able to apply my industry experience into the degree programs we’ll be offering. The challenge of trying to build an ever-evolving curriculum that keeps up with an industry that changes as quickly as ours is definitely not going to be easy - but as I’ve gotten older I’ve realized those are the types of challenges that make me want to get up in the morning.</p>
<p>So, you might be wondering… what on earth am I going to be doing between now and the fall (and the future summers for that matter)? Well - I’ll be working for myself.  This actually supplements my new role quite well, as staying in-tune with the industry from both a technical and relationship level will continue to give me that <em>“real-world”</em> experience I’ll need as I work with students and develop curriculum.</p>
<p>I’m actively looking for and taking on small projects here and there to keep myself busy and stay as knee-deep in the software development industry as I can. I’ve got some work lined up currently and will continue to try to seek out cool projects that I can learn from (if you have any - please feel free to reach out). I will be setting up a business entity and doing all that sorts of stuff over the next few weeks - so stay tuned.</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Today is my last day at Codagami. It’s been almost exactly 3 years since I started, and I can’t say enough about how much I’ve learned an]]>
    </summary>
    
      <category term="Life" scheme="http://ericmbarnard.com/categories/life/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[My First Book is Out]]></title>
    <link href="http://ericmbarnard.com/2013/01/my-first-book-is-out.html"/>
    <id>http://ericmbarnard.com/2013/01/my-first-book-is-out.html</id>
    <published>2013-01-06T21:20:00.000Z</published>
    <updated>2015-04-26T13:20:44.396Z</updated>
    <content type="html"><![CDATA[<img src="/images/my_first_book_is_out.jpg">
<p>I’m pretty excited to announce that my first book, <a href="http://www.packtpub.com/knockoutjs-starter/book" target="_blank" rel="external">KnockoutJS Starter</a>, was recently published. If my blog looked dead for the past several months, it was due to this little project (and a few other things).</p>
<p>Please check it out and leave any feedback/comments here. I would like to write another JavaScript book and constructive feedback would be really appreciated!</p>
<p><a href="http://www.packtpub.com/knockoutjs-starter/book" target="_blank" rel="external">KnockoutJS Starter</a> - Publisher Site<br><a href="http://www.amazon.com/KnockoutJS-Starter-ebook/dp/B00AC1HDJS/" target="_blank" rel="external">KnockoutJS Starter</a> - Amazon</p>
]]></content>
    <summary type="html">
    <![CDATA[<img src="/images/my_first_book_is_out.jpg">
<p>I’m pretty excited to announce that my first book, <a href="http://www.packtpub.com/knockout]]>
    </summary>
    
      <category term="JavaScript" scheme="http://ericmbarnard.com/tags/javascript/"/>
    
      <category term="KnockoutJS" scheme="http://ericmbarnard.com/tags/knockoutjs/"/>
    
      <category term="Development" scheme="http://ericmbarnard.com/categories/development/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Debugging Elmah on Azure]]></title>
    <link href="http://ericmbarnard.com/2012/07/debugging-elmah-on-azure.html"/>
    <id>http://ericmbarnard.com/2012/07/debugging-elmah-on-azure.html</id>
    <published>2012-07-31T12:00:00.000Z</published>
    <updated>2015-04-25T22:13:43.657Z</updated>
    <content type="html"><![CDATA[<p>Recently I was deploying an application to the new Azure Websites service, and I noticed a slight problem with my app.</p>
<p>ELMAH worked on my machine, but not in the cloud.</p>
<p>Needless to say, if your exception logging isn’t working, then you’re probably not going to sleep well at night. So my first question, naturally, was “How in the world do I see what is going on inside ELMAH?”.</p>
<p>One thing that many folks don’t realize until they need to do something like this is that logging libraries tend to “eat” many of their internal exceptions since they are usually the layer that is added to take care of exactly that. I say they “eat” their exceptions not in a strict sense, but more so because there really is no where you can do a “TRY CATCH” to see what is happening.</p>
<h2 id="Tracing_to_the_Rescue">Tracing to the Rescue</h2><p>Instead of throwing exceptions both ELMAH and Log4net output their exceptions to the System.Diagnostics.Trace object. This is sweet when debugging locally, as any application traces will automatically write to the Output window in Visual Studio. But as the title of this post reads, that doesn’t help me at all.</p>
<p>I needed to figure out how to output the traces of my app running in Azure to some storage that I could then view. I did have Log4net working, and it was writing to an SQL Azure database, so I decided to go with that option.</p>
<p>First, I had to learn a few things about ASP.NET and Tracing. ASP.NET has its own tracing mechanism that is somewhat separate from the Diagnostics Tracing (which you can read about here). I could try to write the Diagnostic Trace messages out to the ASP.NET Page Trace mechanism, but in MVC (which I’m using), it doesn’t really work. So, honestly my best bet is to write to a database (as writing to a file in the cloud is not very reliable) using a TraceListener class setup to redirect Trace messages to Log4net’s log.</p>
<p>My TraceListener looked like this:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Diagnostics</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Log4netTraceListener</span> : <span class="title">TraceListener</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> log4net.ILog _log;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Log4netTraceListener</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        _log = log4net.LogManager.GetLogger(<span class="keyword">typeof</span>(Log4netTraceListener));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">string</span> message)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (_log != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _log.Debug(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">WriteLine</span><span class="params">(<span class="keyword">string</span> message)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (_log != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _log.Debug(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, I first tried adding my Log4netTraceListener in the web.config. However, this Listener is initialized and added to the “Trace.Listeners” collection before Log4net has initialized in my web application. So instead, I have to add it programmatically during the application startup. I did the following in my Global.asax.cs:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">System.Diagnostics.Trace.Listeners.Add(<span class="keyword">new</span> Log4netTraceListener());</span><br></pre></td></tr></table></figure>
<p>After all of that, I finally started seeing the following in my Log4net log:</p>
<blockquote>
<p>System.Data.SqlClient.SqlException (0x80131904): Tables without a clustered index are not supported in this version of SQL Server. Please create a clustered index and try again.</p>
</blockquote>
<p>Whoa, that is not something I expected to see. Apparently the “ELMAH_Error” table has a non-clustered primary key and no clustered index on the table (not really sure why). So we have two options:</p>
<ol>
<li>Add another column to the table and setup a clustered index on that column.</li>
<li>The “Sequence” column is already an “int IDENTITY(1,1)” column - so just setup a clustered index on that column.</li>
</ol>
<p>I chose option 2. And here’s the change to apply after executing the default <a href="https://code.google.com/p/elmah/source/browse/src/Elmah/SQLServer.sql" target="_blank" rel="external">ELMAH SQL Script</a>:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> CLUSTERED <span class="keyword">INDEX</span> [IC_Elmah_Sequence] <span class="keyword">on</span> dbo.[ELMAH_Error] (Sequence)</span></span><br></pre></td></tr></table></figure>]]></content>
    <summary type="html">
    <![CDATA[<p>Recently I was deploying an application to the new Azure Websites service, and I noticed a slight problem with my app.</p>
<p>ELMAH worke]]>
    </summary>
    
      <category term="Azure" scheme="http://ericmbarnard.com/tags/azure/"/>
    
      <category term="SQL" scheme="http://ericmbarnard.com/tags/sql/"/>
    
      <category term="Development" scheme="http://ericmbarnard.com/categories/development/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Getting Started with LocalDB]]></title>
    <link href="http://ericmbarnard.com/2012/07/getting-started-with-localdb.html"/>
    <id>http://ericmbarnard.com/2012/07/getting-started-with-localdb.html</id>
    <published>2012-07-04T22:12:06.000Z</published>
    <updated>2015-04-26T14:11:57.688Z</updated>
    <content type="html"><![CDATA[<p>With the launch of SQL Server 2012, a new product called “LocalDB” was launched. This new toy is a great fit for needs that fall somewhere in the space between SQL Express and SQL Compact.</p>
<p>While you can read the full list of features for LocalDB, I’ll highlight a few below:</p>
<ul>
<li>Easy, and simple MSI to install. I’ve had very little problems with this, and it is light-years better than trying to setup SQL Express</li>
<li>Ability to control user access to the database</li>
<li>Supports virtually all features of SQL Express (Stored Procedures, Triggers, … even some basic Replication)</li>
<li>Not an extra service on your machine to manage</li>
</ul>
<p>Initially, there was some confusion as to whether LocalDB was high-powered file-based database or just a dumbed-down version of SQL Express. I’m not going to debate the semantics of what it is exactly, but I will tell you that you get your standard “.mdf” and “.ldf” files with LocalDB. However, the MSI installs some central libraries and an engine that power the LocalDB instances. The engine does have to have some knowledge as to the existence of any instances of LocalDB in order for those to work. So if you were looking for something where you can just drop a file into a directory and it will just work… not quite, but close.</p>
<h2 id="Instances">Instances</h2><p>LocalDB has the notion of “Automatic” and “Named” instances. Per version of LocalDB installed on your machine, there is only one “Automatic” instance per user. You can think of this as the default “SQLEXPRESS” instance that is installed when you first download and install SQL Express on a machine, only it is unique per user on the machine. So if you create an application that creates and uses the “Automatic” instance of LocalDB and this application is installed on a machine with 3 different user accounts, you will have 3 different “.mdf” and “.ldf” files after each user logs in and uses the application the first time.  This “Automatic” instance is:</p>
<ul>
<li>“Public” – meaning any application process under the user’s account can access the instance when logged into a machine</li>
<li>Accessed via the connection string “(localdb){major version}” – which for right now means you’ll use “(localdb)\v11.0”</li>
</ul>
<img src="/images/getting-started-with-local-db-01.png">
<ul>
<li>Great for development purposes when you need to just throw together a DB and ship something</li>
</ul>
<h2 id="Named_Instances">Named Instances</h2><p>The “Named” instance of LocalDB refers to private instances of a database that you can setup. These are useful if you want an application to have a separate, private database per user on a machine (a “Named” instance will run in a separate process under the current user on a machine).</p>
<h2 id="Sharing_Instances">Sharing Instances</h2><p>So what if you want to allow multiple users on a machine to have access to a single LocalDB database instance? Well you can also “share” a “Named” instance of LocalDB. You can control who the instance is shared with, and you can enable/disable sharing at any time.</p>
<p>When connecting with a shared instance, your connection string will need to include an extra “.\” in the server portion. Going with the example above, one would use: “(localdb).\MySharedInstance”. This tells the engine that this is a shared instance.</p>
<h2 id="SqlLocalDb_Utility">SqlLocalDb Utility</h2><p>When you install LocalDB on a machine, it also installs the SqlLocalDb command line utility. It’s pretty simple to use, and allows you to setup batch files to control the creation of your LocalDB’s. One of the first things I do is create a “SetupDb.cmd” file in my source code folder of an app I’m building. This allows other devs to easily replicate setting up a development database on their machine in the same way.</p>
<img src="/images/getting-started-with-local-db-02.png">
<h2 id="Where_Does_Everything_Go?">Where Does Everything Go?</h2><p>One of my first questions was, where are the actual database files?</p>
<blockquote>
<p>The default is: “C:\Users{USER}\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances”</p>
</blockquote>
<p>If I’ve created the “Northwind” Named instance as above, and I go to the default folder, I will see:</p>
<img src="/images/getting-started-with-local-db-03.png">
<p>Inside each of these folders are your typical “master.mdf” , “temp.mdf”, log files, etc… If you want to create your database’s “.mdf” and “.ldf” files in a separate directory, you can easily do that by specifying the location when running a T-SQL statement to “CREATE DATABASE …”. Specifying where your data lives is not really any different than what you’ve done with SQL Server in the past.</p>
<p>If you want to point your application to specific ‘.mdf” or “.ldf” files at runtime, you can specify that in your connection string using the “AttachDbFileName” attribute, you can also read more <a href="https://msdn.microsoft.com/en-us/library/hh309441.aspx" target="_blank" rel="external">here</a>.</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>With the launch of SQL Server 2012, a new product called “LocalDB” was launched. This new toy is a great fit for needs that fall somewher]]>
    </summary>
    
      <category term="SQL" scheme="http://ericmbarnard.com/tags/sql/"/>
    
      <category term="Development" scheme="http://ericmbarnard.com/categories/development/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[JavaScript Basics - Native Stuff]]></title>
    <link href="http://ericmbarnard.com/2011/11/javascript-basics-native-stuff.html"/>
    <id>http://ericmbarnard.com/2011/11/javascript-basics-native-stuff.html</id>
    <published>2011-11-01T13:29:23.000Z</published>
    <updated>2015-04-26T14:12:04.583Z</updated>
    <content type="html"><![CDATA[<p>For a while I’ve been wanting to write about some core things that I’ve learned while creating complex JavaScript applications. Not necessarily ‘begginer’ things, but I guess someone could use these as so.</p>
<p>I also build on the .NET platform. Think what you will, but I like it… and I’ve written Ruby (liked it too), and love JavaScript (a dynamic language at that) development.</p>
<p>First off JavaScript does have some core types that should be understood. My attempt to describe them below is for someone coming from a strongly typed world:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Boolean</code></td>
<td>true/false</td>
</tr>
<tr>
<td><code>String</code></td>
<td>character array</td>
</tr>
<tr>
<td><code>Number</code></td>
<td>float (can be used as integer, decimal, etc…)</td>
</tr>
<tr>
<td><code>null</code></td>
<td>null</td>
</tr>
<tr>
<td><code>undefined</code></td>
<td>basically non-existent, values can’t be initialized to <code>undefined</code></td>
</tr>
<tr>
<td><code>Object</code></td>
<td>essentially a dictionary/hash table of key values</td>
</tr>
<tr>
<td><code>Array</code></td>
<td>not really a true array, but an object with numerical keys, and native manipulation functions. Think more ‘special object’ than ordered sets in memory</td>
</tr>
<tr>
<td><code>Function</code></td>
<td>objects that can be invoked, but still can exist as singular objects</td>
</tr>
</tbody>
</table>
<p>So lets address the first big question, what’s the difference between <code>null</code> and <code>undefined</code>? <code>null</code> and <code>undefined</code> are very similar, however <code>undefined</code> seems to be what most browsers use to indicate something hasn’t been declared or initialized. <code>null</code> is something that is used when you perhaps want to initialize an object or property, but don’t want it to have a value.</p>
<p>Ok, so how about this Array vs Object thing? First off, Arrays DO have the following properties/methods:<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [];</span><br><span class="line">arr.length; <span class="comment">// Number</span></span><br><span class="line">arr.push    <span class="comment">// Function</span></span><br><span class="line">arr.shift;  <span class="comment">// Function</span></span><br><span class="line">arr.unshift; <span class="comment">// Function</span></span><br><span class="line">arr.splice; <span class="comment">// Function</span></span><br><span class="line">arr.slice;  <span class="comment">// Function</span></span><br><span class="line">arr.pop;    <span class="comment">// Function</span></span><br><span class="line">arr.join;   <span class="comment">// Function</span></span><br><span class="line">arr.concat; <span class="comment">// Function</span></span><br></pre></td></tr></table></figure></p>
<p>I won’t get into those here, especially when you have <a href="http://www.w3schools.com/jsref/jsref_obj_array.asp" target="_blank" rel="external">this</a></p>
<p>However, depending on the browser that you are using, these are not usually the super-efficient data structures that we’re used to. They are still very useful, I just want you to be informed.</p>
<p>Lastly, what is this <code>Function</code> thing?</p>
<p>Functions, like I mentioned, can be invoked and have parameters passed to them (they can do a lot more, but I can’t put it all in one post, right?) Essentially a <code>Function</code> is an object that you can create and execute logic inside. You can hang it off of a regular object and make a method (like we’re normally used to) or some other fancy things we’ll get to.</p>
<p>Here’s a decent example of building out a basic object:<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> car = &#123;&#125;; <span class="comment">//a new object</span></span><br><span class="line">car.name = <span class="string">"Corvette"</span>; <span class="comment">//a string</span></span><br><span class="line">car.maxSpeed = <span class="number">155</span>; <span class="comment">//a number</span></span><br><span class="line">car.currentSpeed = <span class="literal">null</span>; <span class="comment">//initializing to null</span></span><br><span class="line">car.honk = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123; <span class="comment">//a function</span></span><br><span class="line">    alert(<span class="string">"Honk"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>A couple things you may have noticed so far… creating new objects and arrays.<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">//Dont' do</span></span><br><span class="line"><span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Don't do</span></span><br><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br></pre></td></tr></table></figure></p>
<p>Use the shorthand and not the “new” keyword for native objects. Its pointless and is extra keysstrokes for your fingers.</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>For a while I’ve been wanting to write about some core things that I’ve learned while creating complex JavaScript applications. Not neces]]>
    </summary>
    
      <category term="JavaScript" scheme="http://ericmbarnard.com/tags/javascript/"/>
    
      <category term="Development" scheme="http://ericmbarnard.com/categories/development/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[SQL Script Generation Column Names]]></title>
    <link href="http://ericmbarnard.com/2011/08/sql-script-generation-column-names.html"/>
    <id>http://ericmbarnard.com/2011/08/sql-script-generation-column-names.html</id>
    <published>2011-08-08T17:00:00.000Z</published>
    <updated>2015-04-25T22:13:33.421Z</updated>
    <content type="html"><![CDATA[<p>When I’m doing heavy database development, one of the biggest annoyances I run into is having to hand key (or clumsily generate) the column names for stored procedures (especially those containing MERGE statements). I really wished I could use something to quickly output the columns to text so I could copy and paste the formatted column names as I needed them… well voila.</p>
<p>Our head DBA always has a few tricks up his sleeve, so we setup a system stored procedure to print out the column names (comma separated of course) for what ever table we want.</p>
<p>The PROC allows you to specify:</p>
<ul>
<li>Table Name (as it appears in the SYS.tables table)</li>
<li>‘L’ or ‘W’ depending if you want the columns listed with a {CRLF} after each column (‘L’) or all on one line (‘W)</li>
<li>A ColumnName prefix (for doing table aliases)</li>
<li>A table schema (if you have other table schema’s besides ‘dbo’)</li>
</ul>
<p>Here’s the code (make sure to look at the bottom):<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">USE</span> [<span class="keyword">master</span>]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> [dbo].[sp_listcolumns]</span><br><span class="line">    @<span class="keyword">table</span>  SYSNAME,</span><br><span class="line">    @list   <span class="built_in">CHAR</span>(<span class="number">1</span>) = <span class="string">'L'</span>,</span><br><span class="line">    @prefix SYSNAME = <span class="string">''</span>,</span><br><span class="line">    @<span class="keyword">schema</span> SYSNAME = <span class="string">'dbo'</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">SET</span> QUOTED_IDENTIFIER OFF</span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span> @columnlist <span class="keyword">NVARCHAR</span>(<span class="number">4000</span>)</span><br><span class="line">       ,@colctr <span class="built_in">INT</span> = <span class="number">1</span></span><br><span class="line">       ,@sqlcmd <span class="keyword">NVARCHAR</span>(<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> #<span class="keyword">column</span></span><br><span class="line">(</span><br><span class="line">    ColumnName <span class="keyword">NVARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    Ordinal <span class="built_in">INT</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> CLUSTERED <span class="keyword">INDEX</span> IC_ColumnList99 <span class="keyword">ON</span> #<span class="keyword">column</span> (Ordinal)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> @columnlist =    <span class="string">''</span></span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">table</span> =        <span class="keyword">LTRIM</span>(<span class="keyword">RTRIM</span>(@<span class="keyword">table</span>))</span><br><span class="line"><span class="keyword">SET</span> @list =         <span class="keyword">LTRIM</span>(<span class="keyword">RTRIM</span>(@list))</span><br><span class="line"><span class="keyword">SET</span> @prefix =       <span class="keyword">LTRIM</span>(<span class="keyword">RTRIM</span>(@prefix))</span><br><span class="line"><span class="keyword">SET</span> @<span class="keyword">schema</span> =       <span class="keyword">LTRIM</span>(<span class="keyword">RTRIM</span>(@<span class="keyword">schema</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> #<span class="keyword">column</span> (ColumnName, Ordinal)</span><br><span class="line"><span class="keyword">SELECT</span>  <span class="string">'['</span>+<span class="keyword">LTRIM</span>(<span class="keyword">RTRIM</span>(COLUMN_NAME))+<span class="string">']'</span>, ORDINAL_POSITION</span><br><span class="line"><span class="keyword">FROM</span>    INFORMATION_SCHEMA.<span class="keyword">COLUMNS</span></span><br><span class="line"><span class="keyword">WHERE</span>   TABLE_NAME = @<span class="keyword">table</span> <span class="keyword">AND</span></span><br><span class="line">        TABLE_SCHEMA = @<span class="keyword">schema</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> ORDINAL_POSITION</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Check to make sure we actually got usuable input from the User</span></span><br><span class="line"><span class="keyword">IF</span> ((<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> #<span class="keyword">column</span>) = <span class="number">0</span>)</span><br><span class="line">RAISERROR(<span class="string">'Bad Table Information - Please Try Again'</span>, <span class="number">16</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span>(@prefix &lt;&gt; <span class="string">''</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">UPDATE</span> #<span class="keyword">column</span></span><br><span class="line">    <span class="keyword">SET</span>    ColumnName = @prefix + ColumnName</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span>(@list = <span class="string">'L'</span>)</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="comment">-- If it is 'L' just append a ',' to each line, output would be:</span></span><br><span class="line">        <span class="comment">-- TestCol1,</span></span><br><span class="line">        <span class="comment">-- TestCol2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">UPDATE</span>  C</span><br><span class="line">        <span class="keyword">SET</span>     @columnlist = @columnlist + C.ColumnName + <span class="string">','</span> + <span class="built_in">CHAR</span>(<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">FROM</span>    #<span class="keyword">column</span> C</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="comment">-- else we output a 'w' where it just a ',' separated list of Column names</span></span><br><span class="line">        <span class="keyword">UPDATE</span>  C</span><br><span class="line">        <span class="keyword">SET</span>     @columnlist = @columnlist + C.ColumnName + <span class="string">','</span></span><br><span class="line">        <span class="keyword">FROM</span>    #<span class="keyword">column</span> C</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- Remove the last comma</span></span><br><span class="line">        <span class="keyword">SET</span> @columnlist = <span class="keyword">LEFT</span>(@columnlist,<span class="keyword">LEN</span>(@columnlist) - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Output the results so that they can be nicely copy</span></span><br><span class="line"><span class="comment">-- and pasted from the comment window</span></span><br><span class="line">PRINT(@columnlist)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">SET</span> NOCOUNT OFF</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span></span></span><br></pre></td></tr></table></figure></p>
<p>Lastly we need to add this as a system proc, or else it never changes its scope to the DB you are running it in</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">EXECUTE</span> sp_MS_marksystemobject <span class="string">'sp_listcolumns'</span></span></span><br></pre></td></tr></table></figure>
<p>After we have this proc build and added, we can get output like this:<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dbo.Test</span><br><span class="line">(</span><br><span class="line">    Id UNIQUEIDENTIFIER</span><br><span class="line">    ,TestCol1 <span class="keyword">NVARCHAR</span>(<span class="number">64</span>)</span><br><span class="line">    ,TestCol2 <span class="built_in">INT</span></span><br><span class="line">    ,TestCol3 <span class="built_in">BIT</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"></span><br><span class="line">sp_listcolumns <span class="string">'test'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--Outputs:</span></span><br><span class="line">[Id],</span><br><span class="line">[TestCol1],</span><br><span class="line">[TestCol2],</span><br><span class="line">[TestCol3],</span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line">sp_listcolumns <span class="string">'test'</span>,<span class="string">'w'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--Outputs:</span></span><br><span class="line">[Id],[TestCol1],[TestCol2],[TestCol3]</span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line">sp_listcolumns <span class="string">'test'</span>,<span class="string">'l'</span>,<span class="string">'testTable.'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--Outputs:</span></span><br><span class="line">testTable.[Id],</span><br><span class="line">testTable.[TestCol1],</span><br><span class="line">testTable.[TestCol2],</span><br><span class="line">testTable.[TestCol3],</span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line">sp_listcolumns <span class="string">'test'</span>,<span class="string">'w'</span>,<span class="string">'testTable.'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--Outputs:</span></span><br><span class="line">testTable.[Id],testTable.[TestCol1],testTable.[TestCol2],testTable.[TestCol3]</span></span><br></pre></td></tr></table></figure></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>When I’m doing heavy database development, one of the biggest annoyances I run into is having to hand key (or clumsily generate) the colu]]>
    </summary>
    
      <category term="SQL" scheme="http://ericmbarnard.com/tags/sql/"/>
    
      <category term="Development" scheme="http://ericmbarnard.com/categories/development/"/>
    
  </entry>
  
</feed>